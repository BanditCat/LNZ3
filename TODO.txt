Optimize code. Shift shape generation to gpu so it can be run time compiled.

